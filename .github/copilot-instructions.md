# GitHub Copilot Instructions for Sugarkube

## Project Overview

Sugarkube is an off-grid k3s cluster platform for Raspberry Pis powered by solar panels. The repository contains:
- Hardware designs (3D CAD models, KiCad schematics)
- Helper scripts for deploying and managing the cluster
- Build automation and CI/CD workflows
- Documentation and guides

The name "sugarkube" refers to both the physical aluminium cube with solar panels AND the syntactic sugar scripts for Kubernetes.

## Repository Structure

- `cad/` — OpenSCAD models for structural parts (Pi carriers, solar brackets, frame)
- `elex/` — KiCad electronics schematics (power_ring board)
- `hardware/` — Accessories and miscellaneous designs
- `docs/` — Build instructions, guides, and learning resources
- `scripts/` — Helper scripts for rendering, building Pi images, flashing, verification
- `tests/` — Test suite for scripts and documentation
- `outages/` — Structured JSON outage records following `outages/schema.json`
- `.github/workflows/` — CI/CD automation (image builds, STL generation, linting, docs validation)

## Development Workflow

**Always run checks before committing:**
```bash
pre-commit run --all-files
pyspelling -c .spellcheck.yaml
linkchecker --no-warnings README.md docs/
git diff --cached | ./scripts/scan-secrets.py
```

Or use the unified helper:
```bash
make docs-verify  # or: just docs-verify, task docs:verify
```

## Coding Standards

### Python
- **Style**: Black formatter with 100 character line length
- **Imports**: isort with black profile
- **Linting**: flake8 via pre-commit
- **Testing**: pytest for unit tests
- **Type hints**: Encouraged where it improves clarity

### Bash Scripts
- Use `/bin/bash` shebang
- Enable error checking: `set -euo pipefail`
- Prefer POSIX-compatible features when possible
- Document parameters and usage in script headers
- Use `--dry-run` flags for preview mode where appropriate

### OpenSCAD Models
- Use parametric designs with configurable variables
- Support multiple render modes via environment variables (e.g., `STANDOFF_MODE`)
- Document parameters at the top of files
- STL files are NOT committed (generated by CI)

### Documentation
- Use aspell for spellchecking (`.spellcheck.yaml`)
- Run linkchecker to validate links
- Keep `.wordlist.txt` updated for project-specific terms
- Follow existing documentation structure and tone

## Testing Requirements

- Add tests for new scripts in `tests/`
- Run existing test suite: `pytest`
- Ensure documentation examples are accurate and tested
- Integration tests require specific environment variables (e.g., `AVAHI_AVAILABLE=1`)

## Build and CI

### Workflows
- `ci.yml` — Runs pre-commit checks on every PR
- `docs.yml` — Validates documentation links and spelling
- `spellcheck.yml` — Runs spellcheck independently
- `tests.yml` — Runs pytest test suite
- `pi-image-release.yml` — Builds and releases Raspberry Pi images
- `scad-to-stl.yml` — Renders OpenSCAD models to STL artifacts
- `kicad-export.yml` — Exports KiCad Gerbers, schematics, and BOMs

### Agent System
See `AGENTS.md` for automated agent workflows:
- **Code Linter Agent**: Runs on every PR
- **Docs Agent**: Validates documentation changes
- **CAD Agent**: Renders SCAD models
- **KiCad Agent**: Exports electronics schematics
- **Outage Agent**: Documents failures as structured JSON

## Key Scripts

- `build_pi_image.sh` — Builds Raspberry Pi OS image with k3s preinstalled
- `flash_pi_media.sh` — Streams images to removable media with verification
- `pi_node_verifier.sh` — Checks k3s prerequisites (supports `--json`, `--full`)
- `pi_smoke_test.py` — SSH wrapper for remote verification
- `collect_support_bundle.py` — Gathers diagnostics into timestamped archives
- `openscad_render.sh` — Renders individual SCAD models locally
- `scan-secrets.py` — Scans diffs for sensitive data
- `checks.sh` — Unified linting and testing entry point

## Security

- **Never commit secrets** — Use `.sops.yaml` for encrypted secrets
- Always scan staged changes: `git diff --cached | ./scripts/scan-secrets.py`
- The pre-commit hook includes secret scanning
- Use environment variables for sensitive configuration

## Outage Documentation

When documenting failures:
1. Create JSON file in `outages/` following `outages/schema.json`
2. Use reliable timestamp source (worldtimeapi.org or `date -u +%F`)
3. Filename format: `YYYY-MM-DD-description.json`
4. Include root cause and resolution
5. Optional: Create companion `.md` file for detailed reports (referenced via `longForm` field)

## Dependencies

- **Python**: black, isort, flake8, pytest, pyspelling, linkchecker, pre-commit
- **System**: aspell, aspell-en, OpenSCAD, KiCad 9
- **Optional**: GitHub CLI (gh) for release downloads
- **Node**: Only if package.json exists (checks.sh will skip if missing)

## Commit Format

Use emoji-prefixed commits:
```
emoji : short summary

Optional body with more details.
```

## References

- Main README: `README.md`
- Contributing guide: `CONTRIBUTING.md`
- Agent specification: `AGENTS.md`
- LLM overview: `llms.txt`
- Code of Conduct: `CODE_OF_CONDUCT.md`
