name: ci

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Install bats and mDNS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            avahi-daemon \
            avahi-utils \
            bats \
            dbus \
            libnss-mdns

      - name: Ensure Avahi services are running
        run: |
          sudo systemctl start dbus
          sudo systemctl start avahi-daemon
          sudo systemctl status avahi-daemon --no-pager

      - name: Run Bash tests
        env:
          BATS_LIB_PATH: ${{ github.workspace }}/tests/bats
        run: |
          # Run bats tests directly without kcov to avoid xtrace pollution
          # kcov's bash instrumentation interferes with test assertions
          # See outages/2025-11-04-kcov-bash-parse-scope.json
          bats --recursive tests/bats

      - name: Run Python tests with coverage
        id: pytest
        continue-on-error: true
        run: |
          pytest -q --cov=scripts --cov=tests --cov-report=xml:coverage/python-coverage.xml

      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          directory: coverage
          files: |
            coverage/python-coverage.xml
          fail_ci_if_error: true
          verbose: true

      - name: Fail if Python tests failed
        if: steps.pytest.outcome == 'failure'
        run: |
          echo "Pytest failed; see previous logs for details." >&2
          exit 1
