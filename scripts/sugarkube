#!/usr/bin/env bash
set -euo pipefail

find_python() {
  if [ -n "${SUGARKUBE_PYTHON:-}" ]; then
    echo "$SUGARKUBE_PYTHON"
    return 0
  fi

  if command -v python3 >/dev/null 2>&1; then
    echo python3
    return 0
  fi

  if command -v python >/dev/null 2>&1; then
    echo python
    return 0
  fi

  echo "Unable to find a Python interpreter for sugarkube_toolkit." >&2
  return 1
}

PYTHON_INTERPRETER="$(find_python)"

# Ensure the repository root is available on PYTHONPATH even when the
# wrapper is launched from a different working directory. This mirrors the
# behavior suggested in the documentation where `scripts/` is added to PATH.
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if [ -d "$PROJECT_ROOT" ]; then
  if [ -n "${PYTHONPATH:-}" ]; then
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
  else
    export PYTHONPATH="$PROJECT_ROOT"
  fi
fi

exec "$PYTHON_INTERPRETER" -m sugarkube_toolkit "$@"
