{
  "id": "ci-python314-module-import-inline-scripts",
  "date": "2025-11-06",
  "component": "k3s Discovery - mDNS Query",
  "rootCause": "The k3s-discover.sh script used 'env' command with a minimal set of explicit variables when running inline Python code. The env command with only explicit variables creates a clean environment, losing all other environment variables including PATH, PYTHONPATH, HOME, USER, TMPDIR, and others. Python 3.14's subprocess.run and module import system requires a more complete environment to function properly. Without PATH, subprocess calls to avahi-browse fail. Without a proper environment, Python 3.14 cannot import modules or execute subprocesses reliably, causing empty results in mDNS discovery tests.",
  "resolution": "Removed use of 'env' command with minimal variable sets. Instead, directly export the required variables (SUGARKUBE_CLUSTER, SUGARKUBE_ENV, SUGARKUBE_TOKEN, SCRIPT_DIR) and run python3 with the inherited environment. This preserves all necessary system environment variables while still setting the application-specific ones needed. Added sys.path manipulation as additional safety for module imports. This approach ensures Python 3.14+ compatibility by maintaining a complete execution environment.",
  "references": [
    "scripts/k3s-discover.sh",
    "tests/test_mdns_discovery_parsing.py",
    "scripts/k3s_mdns_query.py"
  ]
}
