{
  "id": "ci-python314-module-import-inline-scripts",
  "date": "2025-11-06",
  "component": "k3s Discovery - mDNS Query",
  "rootCause": "Python 3.14 changed how module imports work when using 'python3 -' with stdin scripts. The k3s-discover.sh script uses 'env' command to set specific environment variables when running inline Python code, which starts with a clean environment and loses PYTHONPATH and PATH. The inline Python code imports modules from the scripts directory and executes avahi-browse command via subprocess. Without PYTHONPATH, Python 3.14 cannot import local modules. Without PATH, subprocess calls to avahi-browse fail (especially in tests that mock avahi-browse in temporary directories). This caused import failures and empty results in mDNS discovery tests on Python 3.14.",
  "resolution": "Modified inline Python scripts in k3s-discover.sh to: 1) Explicitly preserve PYTHONPATH and PATH when using 'env' command by adding them to environment variable arrays in run_avahi_query and mdns_absence_check_cli functions, and 2) Add SCRIPT_DIR to sys.path programmatically before imports as a fallback. This multi-layer approach ensures Python 3.14+ compatibility by preserving critical environment variables and providing explicit module search paths, enabling proper subprocess execution in both production and test environments.",
  "references": [
    "scripts/k3s-discover.sh",
    "tests/test_mdns_discovery_parsing.py",
    "scripts/k3s_mdns_query.py"
  ]
}
