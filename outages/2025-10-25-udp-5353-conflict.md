# 2025-10-25: UDP/5353 conflicts masking Avahi advertisements

## Symptoms
- `k3s-discover.sh` self-checks for `_k3s-CLUSTER-ENV._tcp` time out
  while `avahi-publish` reports success.
- `avahi-browse -rt _services._dns-sd._udp` flickers; entries appear briefly
  before disappearing.
- Wi-Fi clients still discover Homebridge or casting devices, yet the K3s
  control plane stays hidden.

## Root cause
- Browser mDNS helpers (Firefox, Chrome), Homebridge, or IoT bridges bind
  UDP/5353 before Avahi starts.
- When they launch under the same user as `avahi-daemon`, they win the socket
  and Avahi falls back to a stub.
- Publishers log success even though browse queries stop returning
  `_k3s-*.local` records for the host.

## Fix
- Run `scripts/net_diag.sh` after a failed `mdns_selfcheck.sh` to list the
  processes bound to UDP/5353.
- Stop or reconfigure the conflicting daemon so only `avahi-daemon` owns the
  port (for example the Homebridge proxy).
- Restart Avahi with `systemctl restart avahi-daemon` once the port is free to
  refresh the multicast subscription.

## Verification steps
1. `lsof -nP -i UDP:5353` or `ss -ulpn 'sport = 5353'` lists only
   `avahi-daemon`.
2. `scripts/k3s-discover.sh --test-bootstrap-publish` completes without
   triggering the fallback diagnostics.
3. `avahi-browse -rt _k3s-*.local` shows the publishing host persistently
   across multiple scans.

## References
- `scripts/net_diag.sh`
- `scripts/k3s-discover.sh`
- `scripts/mdns_selfcheck.sh`
