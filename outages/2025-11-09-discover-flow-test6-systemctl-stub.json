{
  "id": "2025-11-09-discover-flow-test6-systemctl-stub",
  "date": "2025-11-09",
  "component": "tests/bats/discover_flow.bats:646",
  "rootCause": "Test 6 'discover flow elects winner after self-check failure' (line 646) timed out because the systemctl stub in stub_common_network_tools() only handled the 'is-active' command. When k3s-discover.sh attempted to reload or restart avahi-daemon during the bootstrap publish flow (after writing service files), it called the real systemctl command which required interactive authentication in the non-root test environment. This caused the script to hang waiting for authentication, eventually hitting the test timeout.",
  "resolution": "Extended the systemctl stub in stub_common_network_tools() function (lines 30-44) to handle 'reload', 'restart', and 'start' commands in addition to 'is-active'. The stub now returns exit code 0 immediately for these systemd operations, allowing the test to complete the full bootstrap election flow without requiring actual systemd service management. Test now passes consistently in <5 seconds, validating that a node discovering no existing servers can win the election and proceed to bootstrap k3s as the initial control-plane server.",
  "references": [
    "tests/bats/discover_flow.bats:646-743 (Test 6: elects winner)",
    "tests/bats/discover_flow.bats:16-44 (stub_common_network_tools)",
    "scripts/k3s-discover.sh:1102-1115",
    "notes/ci-test-failures-remaining-work.md",
    "notes/skipped-tests-status.md"
  ]
}
