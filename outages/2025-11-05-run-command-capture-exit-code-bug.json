{
  "id": "2025-11-05-run-command-capture-exit-code-bug",
  "date": "2025-11-05",
  "component": "scripts/mdns_helpers.sh:run_command_capture()",
  "rootCause": "The run_command_capture function incorrectly captured command exit codes due to using 'if ! output=\"$(...)\"' pattern. When a command failed, the exit code was checked via $? AFTER the if-test had already consumed it, resulting in $? always being 0 (success of the if-test itself) instead of the actual command exit code. This caused resolve_host() to treat failed resolution commands as successful, leading it to attempt IP parsing on error messages and returning status 2 (ipv4_mismatch) instead of status 1 (resolve_failed).",
  "resolution": "Simplified the exit code capture from 'if ! output=\"$(...)\"; then rc=$?; else rc=0; fi' to 'output=\"$(...)\"; rc=$?' to correctly preserve the command's actual exit code. This ensures resolution failures are properly detected and classified, allowing the warning logic at line 856-881 of mdns_selfcheck.sh to correctly handle browse-success + resolve-failure scenarios.",
  "references": [
    "tests/bats/mdns_selfcheck.bats:387-425",
    "scripts/mdns_helpers.sh:55-61",
    "scripts/mdns_resolution.sh:resolve_host()",
    "scripts/mdns_selfcheck.sh:856-881",
    "notes/ci-test-fixes-action-plan.md:958"
  ]
}
