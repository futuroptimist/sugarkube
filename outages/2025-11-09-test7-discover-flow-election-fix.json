{
  "id": "test7-discover-flow-election-fix",
  "date": "2025-11-09",
  "component": "tests/bats/discover_flow.bats::Test 6",
  "longForm": "outages/2025-11-09-test7-discover-flow-election-fix.md",
  "rootCause": "Test 6 'discover flow elects winner after self-check failure' (line 646) failed due to four critical test infrastructure bugs: (1) Wrong environment variable name (MDNS_ABSENCE_GATE instead of SUGARKUBE_MDNS_ABSENCE_GATE) caused absence gate to run, querying real Avahi daemon and hanging test; (2) Broken timeout stub that returned exit 0 without executing the command, preventing k3s-discover.sh from running at all; (3) Incorrect mdns_selfcheck stub that always failed with status 94, preventing successful completion after election; (4) Wrong test expectations checking for bootstrap role/phase instead of server role/phase after election.",
  "resolution": "Fixed four test bugs: (1) Changed MDNS_ABSENCE_GATE=0 to SUGARKUBE_MDNS_ABSENCE_GATE=0 to correctly skip absence gate; (2) Fixed timeout stub to 'shift; exec \"$@\"' to actually execute commands; (3) Created smart mdns_selfcheck stub that checks SUGARKUBE_EXPECTED_ROLE environment variable, failing for bootstrap role (exit 94) but succeeding for server role (exit 0); (4) Fixed test expectations from txt=role=bootstrap/txt=phase=bootstrap to txt=role=server/txt=phase=server to match actual behavior after election. Test 6 now passes successfully.",
  "references": [
    "outages/2025-11-09-test7-discover-flow-election-fix.md (detailed postmortem)",
    "outages/2025-11-08-discover-flow-test7-partial-investigation.json (prior 85% progress)",
    "outages/2025-11-08-k3s-integration-tests-investigation.json (broader context)",
    "tests/bats/discover_flow.bats:646-743 (Test 6: elects winner)",
    "scripts/k3s-discover.sh:166 (SUGARKUBE_MDNS_ABSENCE_GATE variable)",
    "scripts/k3s-discover.sh:3721-3752 (election after bootstrap failure)"
  ]
}
