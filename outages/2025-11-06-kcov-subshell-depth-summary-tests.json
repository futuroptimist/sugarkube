{
  "id": "2025-11-06-kcov-subshell-depth-summary-tests",
  "date": "2025-11-06",
  "component": "tests/bats/summary.bats",
  "rootCause": "Tests 40-41 (summary tests) failed in CI under kcov due to excessive subshell nesting depth. The tests use `run bash -c` which creates a subshell, inside which summary.sh is sourced. The summary__with_strict() function then created another subshell with `( set -Eeuo pipefail; \"$@\" )`. This triple nesting (kcov -> bash -c -> subshell) caused kcov's instrumentation to fail, marking tests as failed even though they executed successfully (visible as 'ok 40' and 'ok 41' in logs before being marked 'not ok').",
  "resolution": "Simplified summary__with_strict() to execute commands directly without any subshell wrapper. All callers (k3s-discover.sh, tests) already set `set -euo pipefail` at the top of their scripts, so the defensive strict-mode wrapper was redundant and causing kcov instrumentation issues. Removing the subshell eliminates the problematic nesting depth while maintaining the same error handling behavior since callers already enforce strict mode.",
  "references": [
    "tests/bats/summary.bats:4-12",
    "tests/bats/summary.bats:23-30",
    "scripts/lib/summary.sh:27-31",
    "scripts/k3s-discover.sh:2",
    ".github/workflows/ci.yml:56-69"
  ]
}
