{
  "id": "2025-10-23-k3s-mdns-trailing-dot-self-check",
  "date": "2025-10-22",
  "component": "scripts/k3s_mdns_parser.py",
  "rootCause": "The Avahi parser left trailing dots on hostnames and TXT leader values when avahi-browse emitted a domain of 'local.', so the mDNS self-check never matched the bootstrap advertisement for the local node.",
  "resolution": "Trim trailing dots, normalise case, and reuse the hostname normaliser for both resolved hosts and TXT leader fields so bootstrap self-checks accept Avahi responses with domain suffixes.\n\n2025-12-08 follow-up: Bound avahi-publish-service with -H to the FQDN, added a 1s self-check delay, and capture output in /tmp/sugar-publish.log to prevent bootstrap races.\nSymptom: bootstrap advert OK; server advert never seen post systemd: Starting k3s within 5s window.\nFix: Publish phase=server advert explicitly, wait up to 60s for confirmation, and retire the bootstrap advert afterwards.\nQuick triage:\n- avahi-browse -rt _k3s-sugar-dev._tcp --parsable | grep 'txt=.*phase='\n- pgrep -a avahi-publish || true\n- sed -n '1,120p' /tmp/sugar-publish-bootstrap.log || true\n- sed -n '1,120p' /tmp/sugar-publish-server.log || true",
  "references": [
    "scripts/k3s_mdns_parser.py",
    "tests/scripts/test_k3s_discover_bootstrap_publish.py",
    "tests/scripts/test_k3s_mdns_parser.py"
  ]
}
