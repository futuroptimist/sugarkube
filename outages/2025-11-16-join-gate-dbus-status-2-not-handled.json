{
  "id": "2025-11-16-join-gate-dbus-status-2-not-handled",
  "date": "2025-11-16",
  "component": "scripts/join_gate.sh wait_for_avahi_bus function",
  "severity": "Critical",
  "status": "Resolved",
  "rootCause": "The wait_for_avahi_bus() function in join_gate.sh only handled exit status 0 (success) from wait_for_avahi_dbus.sh. When wait_for_avahi_dbus.sh exits with status 2 (D-Bus unavailable but CLI tools work), wait_for_avahi_bus() incorrectly treated it as an error and failed the join. This broke the D-Bus fallback mechanism that was added in the 2025-11-16-dbus-method-fallback-missing fix.",
  "impact": "Cross-node k3s cluster joins completely blocked on systems where D-Bus methods are unavailable (e.g., Raspberry Pi 5). Even though mDNS discovery worked perfectly, API validation passed, and all L4 probes succeeded, the join failed at the join_gate step with 'dbus_wait outcome=error status=0'. This prevented formation of multi-node HA clusters despite all the underlying infrastructure working correctly.",
  "resolution": "Modified wait_for_avahi_bus() to properly handle exit status 2 from wait_for_avahi_dbus.sh. Exit status 2 now triggers a 'skip' outcome and allows the join to proceed, matching the behavior of ensure_avahi_liveness_signal() which already handled status 2 correctly. The fix adds a status check that treats exit status 2 as success (return 0) with appropriate logging.",
  "timeline": [
    {
      "timestamp": "2025-11-16T15:01:49-08:00",
      "event": "sugarkube0 successfully bootstraps k3s cluster and publishes mDNS service"
    },
    {
      "timestamp": "2025-11-16T15:05:25-08:00",
      "event": "sugarkube1 starts join attempt with SUGARKUBE_TOKEN_DEV set"
    },
    {
      "timestamp": "2025-11-16T15:08:56-08:00",
      "event": "sugarkube1 successfully discovers sugarkube0 via mDNS (simple_discovery_success)"
    },
    {
      "timestamp": "2025-11-16T15:08:56-08:00",
      "event": "sugarkube1 validates API is alive on sugarkube0:6443 (simple_discovery_api_ok)"
    },
    {
      "timestamp": "2025-11-16T15:08:56-08:00",
      "event": "sugarkube1 completes L4 probes on ports 6443, 2379, 2380 - all open"
    },
    {
      "timestamp": "2025-11-16T15:09:17-08:00",
      "event": "join_gate.sh calls wait_for_avahi_bus() which calls wait_for_avahi_dbus.sh"
    },
    {
      "timestamp": "2025-11-16T15:09:17-08:00",
      "event": "wait_for_avahi_dbus.sh exits with status 2 (D-Bus unavailable, CLI fallback OK)"
    },
    {
      "timestamp": "2025-11-16T15:09:17-08:00",
      "event": "wait_for_avahi_bus() treats status 2 as error, logs 'dbus_wait outcome=error status=0'"
    },
    {
      "timestamp": "2025-11-16T15:09:17-08:00",
      "event": "join_gate.sh fails, k3s join aborted"
    }
  ],
  "evidence": {
    "log_files": [
      "logs/up/20251116T225411Z_a60c1e0_sugarkube0_just-up-dev.log",
      "logs/up/20251116T230525Z_ea5d29e_sugarkube1_just-up-dev.log"
    ],
    "key_log_lines": [
      "ts=2025-11-16T15:08:56-08:00 level=info event=discover event=simple_discovery_success server=sugarkube0.local",
      "ts=2025-11-16T15:08:56-08:00 level=info event=discover event=simple_discovery_api_ok server=sugarkube0.local",
      "ts=2025-11-16T15:08:56-08:00 level=info event=discover event=l4_probe phase=install_join server=\"sugarkube0.local\" result=\"{\\\"host\\\":\\\"sugarkube0.local\\\",\\\"port\\\":6443,\\\"status\\\":\\\"open\\\",\\\"latency_ms\\\":54}\"",
      "ts=2025-11-16T15:09:17-08:00 level=info event=join_gate action=dbus_wait outcome=error status=0",
      "ts=2025-11-16T15:09:17-08:00 level=info event=discover msg=\"join gate wait failed\" severity=error script=/home/pi/sugarkube/scripts/join_gate.sh"
    ],
    "mdns_debug_output": "=== Browse specific k3s service (5 second timeout, filtered) ===\n+   eth0 IPv4 k3s-sugar-dev@sugarkube0.local (server)       _k3s-sugar-dev._tcp  local\n=   eth0 IPv4 k3s-sugar-dev@sugarkube0.local (server)       _k3s-sugar-dev._tcp  local\n   hostname = [sugarkube0.local]\n   txt = [\"ip6=<REDACTED>\" \"ip4=<REDACTED>\" \"host=sugarkube0.local\" \"leader=sugarkube0.local\" \"phase=server\" \"role=server\" \"env=dev\" \"cluster=sugar\" \"k3s=1\"]"
  },
  "testing": {
    "manual_verification": "The fix ensures that exit status 2 from wait_for_avahi_dbus.sh is treated as a soft failure/skip condition (return 0) rather than a hard error (return 1). Existing bats tests validate the overall join_gate functionality.",
    "regression_risk": "Very low. The change only affects the error handling path when wait_for_avahi_dbus.sh exits with status 2. Status 0 continues to work as before, and status 1 continues to be treated as an error. The fix brings wait_for_avahi_bus() behavior in line with ensure_avahi_liveness_signal() which already handled status 2 correctly."
  },
  "prevention": [
    "Added explicit handling for exit status 2 (skip/disabled) in wait_for_avahi_bus()",
    "Added comment explaining that status 2 is a valid success condition",
    "Logs now show 'outcome=skip' for status 2 instead of 'outcome=error'",
    "The fix completes the D-Bus fallback mechanism introduced in 2025-11-16-dbus-method-fallback-missing"
  ],
  "workaround": "Users could set SUGARKUBE_DISABLE_JOIN_GATE=1 to completely bypass the join gate mechanism, but this removes serialization protection for concurrent joins.",
  "references": [
    "scripts/join_gate.sh wait_for_avahi_bus function (lines 92-110)",
    "scripts/wait_for_avahi_dbus.sh CLI fallback (exits with status 2)",
    "scripts/join_gate.sh ensure_avahi_liveness_signal function (lines 106-152, already handled status 2)",
    "outages/2025-11-16-dbus-method-fallback-missing.json",
    "tests/bats/join_gate.bats",
    "tests/wait_for_avahi_dbus_fallback.bats"
  ]
}
