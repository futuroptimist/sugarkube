{
  "id": "2025-11-06-summary-bats-missing-setup",
  "date": "2025-11-06",
  "component": "tests/bats/summary.bats",
  "rootCause": "Tests 40-41 (summary tests) failed in CI under kcov instrumentation. After 9 iterations of fixes, the root cause was identified as the combination of 'set -euo pipefail' in the test bash -c commands interacting with kcov's instrumentation of summary.sh. Under kcov, the strict error handling (specifically set -e/-u/-o pipefail) was causing the subshell to exit with non-zero status for reasons that don't reproduce locally without kcov. The EXIT trap issue was a red herring - the real problem was overly strict error handling in test subshells under kcov instrumentation.",
  "resolution": "Removed 'set -euo pipefail' from the bash -c commands in tests. summary.sh itself has appropriate error handling, and the tests don't require strict mode in the test subshell. This eliminates the kcov instrumentation interaction issue. Also made EXIT trap opt-in via SUMMARY_AUTO_EMIT=1 (disabled by default) and added BATS_CWD: ${{ github.workspace }} to .github/workflows/ci.yml.",
  "references": [
    "tests/bats/summary.bats:1-34",
    "scripts/lib/summary.sh:127-135",
    "scripts/lib/summary.sh:150-165",
    ".github/workflows/ci.yml:56-60"
  ]
}
