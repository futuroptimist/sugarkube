{
  "id": "2025-11-06-summary-bats-missing-setup",
  "date": "2025-11-06",
  "component": "tests/bats/summary.bats",
  "rootCause": "Tests 40-41 (summary tests) failed in CI under kcov instrumentation due to EXIT trap issues. Multiple attempts to detect and skip EXIT trap in BATS environments failed: BATS_TEST_DIRNAME/BATS_VERSION aren't exported to subshells, and IN_BATS_TEST export approaches had reliability issues. The fundamental problem is that EXIT traps in bash -c subshells interfere with kcov's instrumentation and exit status tracking, regardless of detection mechanism.",
  "resolution": "Changed EXIT trap registration to be opt-in via SUMMARY_AUTO_EMIT=1 environment variable, disabled by default. This eliminates all EXIT trap issues in tests and kcov environments while still allowing production scripts to enable auto-emit if desired. Tests and most scripts explicitly call summary::emit, which is clearer and more predictable than relying on EXIT traps. Production scripts that need auto-emit can set SUMMARY_AUTO_EMIT=1. Also added BATS_CWD: ${{ github.workspace }} to .github/workflows/ci.yml.",
  "references": [
    "tests/bats/summary.bats:1-34",
    "scripts/lib/summary.sh:127-135",
    "scripts/lib/summary.sh:150-165",
    ".github/workflows/ci.yml:56-60"
  ]
}
