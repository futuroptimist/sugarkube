{
  "id": "2025-11-06-summary-bats-missing-setup",
  "date": "2025-11-06",
  "component": "tests/bats/summary.bats",
  "rootCause": "Tests 40-41 (summary tests) failed in CI under kcov instrumentation. The root issue was that summary::init registers an EXIT trap that calls summary::emit when the script exits. Under kcov's code coverage instrumentation, this EXIT trap interfered with exit status tracking in the bash -c subshells used by BATS tests. Even though summary::emit uses '|| true' for error handling, kcov's instrumentation layer couldn't properly track the exit status through the trap mechanism, causing the tests to report failure even when the code executed successfully.",
  "resolution": "Modified summary__register_exit_trap_impl() to detect BATS test environments (via BATS_TEST_DIRNAME or BATS_VERSION variables) and skip EXIT trap registration in tests. Tests now explicitly call summary::emit at the end of their bash -c commands, avoiding the kcov instrumentation issues with EXIT traps while maintaining the same functionality. Non-test scripts continue to use EXIT trap for automatic cleanup. Also added BATS_CWD: ${{ github.workspace }} to .github/workflows/ci.yml to ensure the environment variable is available to all tests.",
  "references": [
    "tests/bats/summary.bats:3-19",
    "tests/bats/summary.bats:21-35",
    "scripts/lib/summary.sh:127-135",
    "scripts/lib/summary.sh:144-159",
    ".github/workflows/ci.yml:56-60"
  ]
}
