{
  "id": "2025-11-07-mdns-absence-gate-timeout-fix",
  "date": "2025-11-07",
  "component": "tests/bats/mdns_selfcheck.bats:856",
  "rootCause": "Test 34 'mdns absence gate confirms wipe leaves no advertisements' had two issues: (1) timed out because mdns_absence_gate function used default timeout values (15000ms) that exceeded the test's 30-second timeout, and (2) initially used SUGARKUBE_SERVERS=0 which caused k3s-discover.sh to fail when trying to become an agent without a server to join. Additionally, avahi-publish and avahi-publish-address stubs used non-interruptible 'sleep 60' blocking calls that prevented the absence gate logic from properly terminating publisher processes.",
  "resolution": "Applied timeout overrides via environment variables (MDNS_ABSENCE_TIMEOUT_MS=2000, MDNS_ABSENCE_BACKOFF_START_MS=100, MDNS_ABSENCE_BACKOFF_CAP_MS=500) to reduce absence gate wait time from 15s to 2s. Refactored avahi-publish stubs to use trap handlers with short sleep loops (0.1s) instead of 60s blocking sleep, making them properly interruptible. Updated test to use SUGARKUBE_SERVERS=3 (HA cluster configuration matching repository focus) instead of invalid SERVERS=0 or vestigial SERVERS=1. Added SUGARKUBE_EXIT_AFTER_ABSENCE_GATE=1 flag to k3s-discover.sh to allow test-only exit after absence gate verification without proceeding to k3s installation. Test now completes in ~3-4 seconds and properly validates absence detection for 3-server HA scenarios.",
  "references": [
    "tests/bats/mdns_selfcheck.bats:856-976",
    "scripts/k3s-discover.sh:1766-1976",
    "scripts/k3s-discover.sh:3627-3631",
    "notes/skipped-tests-status.md:167-233"
  ]
}

