{
  "id": "test7-discover-flow-follower-missing-stubs",
  "date": "2025-11-09",
  "component": "tests/bats/discover_flow.bats::Test 7",
  "rootCause": "Test 7 'discover flow remains follower after self-check failure' (line 788) was failing/hanging because critical test infrastructure was missing from Test 6 pattern. Initial fix added stubs but test still hung for 15+ minutes. Root causes: (1) timeout stub that actually executes commands (vs just exiting 0), (2) journalctl stub for Avahi service verification, (3) sleep stub for timing operations, (4) gdbus stub for D-Bus introspection, (5) busctl stub for Avahi D-Bus interactions, (6) directory creation for avahi/services, run, mdns, (7) avahi.conf file creation, (8) SUGARKUBE_CLUSTER and SUGARKUBE_ENV environment variables, (9) SUGARKUBE_MDNS_ABSENCE_GATE=0 to disable absence gate that was causing 15+ min hang, (10) SUGARKUBE_API_READY_TIMEOUT=2 for faster API ready checks. Without SUGARKUBE_MDNS_ABSENCE_GATE=0, test hung indefinitely running absence gate checks instead of reaching follower wait logic.",
  "resolution": "Added all missing stubs and environment variables following Test 6 pattern: (1) timeout stub that shifts first arg and execs remaining command, (2) journalctl stub returning 'Service successfully established' for avahi-daemon queries, (3) sleep stub logging to file, (4) gdbus stub succeeding on introspect calls, (5) busctl stub handling system/timeout flags and returning stub responses for Avahi D-Bus calls, (6) mkdir -p for required directories, (7) minimal avahi.conf with [server] section, (8) added SUGARKUBE_CLUSTER=sugar and SUGARKUBE_ENV=dev, (9) CRITICAL: added SUGARKUBE_MDNS_ABSENCE_GATE=0 to skip absence gate that was causing infinite hang, (10) added SUGARKUBE_API_READY_TIMEOUT=2 to match Test 6. Test now completes quickly (timeout after 1 sec as expected), validating that when node loses bootstrap election (election_stub returns winner=no), it correctly enters follower wait state (outcome=follower logged) and times out with exit status 124.",
  "references": [
    "tests/bats/discover_flow.bats:788-915 (Test 7: remains follower - now with complete stubs)",
    "tests/bats/discover_flow.bats:646-787 (Test 6: pattern source including SUGARKUBE_MDNS_ABSENCE_GATE=0)",
    "outages/2025-11-09-discover-flow-test6-missing-stubs.json (Test 5 similar issue)",
    "scripts/k3s-discover.sh:3754 (where outcome=follower is logged)",
    "scripts/k3s-discover.sh:166 (SUGARKUBE_MDNS_ABSENCE_GATE variable check)",
    "docs/raspi_cluster_setup.md (real-world Pi cluster use case)"
  ]
}
