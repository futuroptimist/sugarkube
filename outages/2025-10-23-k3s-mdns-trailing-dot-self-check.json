{
  "id": "2025-10-23-k3s-mdns-trailing-dot-self-check",
  "date": "2025-10-23",
  "component": "scripts/k3s_mdns_parser.py",
  "rootCause": "The Avahi parser left trailing dots on hostnames and TXT leader values when avahi-browse emitted a domain of 'local.', so the mDNS self-check never matched the bootstrap advertisement for the local node.",
  "resolution": "Trim trailing dots, normalise case, and reuse the hostname normaliser for both resolved hosts and TXT leader fields so bootstrap self-checks accept Avahi responses with domain suffixes.",
  "references": [
    "scripts/k3s_mdns_parser.py",
    "tests/scripts/test_k3s_discover_bootstrap_publish.py",
    "tests/scripts/test_k3s_mdns_parser.py"
  ],
  "notes": [
    "Symptom: bootstrap publisher logged a PID but avahi-browse never surfaced a _k3s advert.",
    "Impact: just up dev aborted and risked a split-brain when node 2 attempted to join.",
    "Fix: bind avahi-publish-service with -H <FQDN>, add a 1s settle delay, and tee output to /tmp/sugar-publish.log.",
    "Phase: bootstrap self-check now logs phase=self-check host=<fqdn> to make retries explicit.",
    "Quick triage: avahi-browse -rt _k3s-sugar-dev._tcp --parsable | sed -n '1,80p'",
    "Quick triage: pgrep -a avahi-publish || true",
    "Quick triage: sed -n '1,80p' /tmp/sugar-publish.log || true"
  ]
}
