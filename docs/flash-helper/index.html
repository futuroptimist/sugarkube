<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sugarkube Flash Helper</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.5;
      }

      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: #f8fafc;
      }

      main {
        margin: 0 auto;
        max-width: 960px;
        padding: 3rem 1.5rem 4rem;
      }

      h1 {
        font-size: clamp(2.25rem, 3vw + 1rem, 3rem);
        margin-bottom: 0.5rem;
      }

      p.lead {
        font-size: 1.125rem;
        opacity: 0.85;
        margin-top: 0;
        margin-bottom: 1.75rem;
      }

      form {
        display: grid;
        gap: 1rem;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 18px 48px rgba(15, 23, 42, 0.35);
      }

      label {
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      input[type="url"],
      select {
        font: inherit;
        padding: 0.65rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.75);
        color: inherit;
      }

      input[type="url"]:focus,
      select:focus {
        outline: 2px solid #38bdf8;
        outline-offset: 2px;
      }

      button {
        justify-self: flex-start;
        padding: 0.65rem 1.25rem;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        background: linear-gradient(135deg, #38bdf8, #14b8a6);
        color: #0f172a;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 32px rgba(56, 189, 248, 0.45);
      }

      .result-card {
        margin-top: 2.5rem;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 1.75rem;
        box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.15);
      }

      .result-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .steps {
        margin-top: 1.5rem;
        display: grid;
        gap: 1.25rem;
      }

      .step {
        background: rgba(15, 23, 42, 0.75);
        border-radius: 0.85rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 1.25rem;
      }

      .step h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
      }

      .step p {
        margin: 0.35rem 0;
      }

      pre {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 0.65rem;
        padding: 0.9rem;
        overflow-x: auto;
        font-size: 0.9rem;
      }

      code {
        font-family: "JetBrains Mono", "Fira Code", monospace;
      }

      .error {
        margin-top: 1rem;
        color: #fca5a5;
        font-weight: 600;
      }

      footer {
        margin-top: 3rem;
        font-size: 0.85rem;
        opacity: 0.7;
      }

      @media (max-width: 640px) {
        .result-meta {
          flex-direction: column;
          gap: 0.75rem;
        }

        form {
          padding: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Sugarkube Flash Helper</h1>
      <p class="lead">
        Paste a GitHub Actions run URL, choose your operating system, and the helper will
        generate download → verify → flash instructions tailored to your workstation.
      </p>

      <form id="flash-form">
        <label>
          Workflow run URL
          <input
            type="url"
            id="workflow-url"
            name="workflow-url"
            placeholder="https://github.com/futuroptimist/sugarkube/actions/runs/..."
            required
          />
        </label>
        <label>
          Workstation OS
          <select id="os" name="os">
            <option value="linux">Linux</option>
            <option value="mac">macOS</option>
            <option value="windows">Windows</option>
          </select>
        </label>
        <button type="submit">Generate instructions</button>
        <p id="error" class="error" hidden></p>
      </form>

      <section id="results" class="result-card" hidden>
        <div class="result-meta">
          <span id="meta-repo"></span>
          <span id="meta-run"></span>
          <span id="meta-platform"></span>
        </div>
        <div id="steps" class="steps"></div>
      </section>

      <footer>
        Looking for the command-line equivalent? Run
        <code>python scripts/workflow_flash_instructions.py --help</code> inside the repository.
      </footer>
    </main>

    <script>
      const OS_LABELS = {
        linux: "Linux",
        mac: "macOS",
        windows: "Windows",
      };

      const STEP_TEMPLATES = {
        linux: [
          {
            title: "Install GitHub CLI and utilities",
            body: [
              "Install the GitHub CLI plus tools required to verify and expand the image.",
            ],
            commands: [
              "sudo apt-get update",
              "sudo apt-get install -y gh xz-utils coreutils",
            ],
          },
          {
            title: "Authenticate GitHub CLI",
            body: [
              'Run the interactive login once so "gh" can download workflow artifacts.',
            ],
            commands: ["gh auth login --web"],
          },
          {
            title: "Create an images directory",
            body: [
              "Store the artifacts in a predictable path. Feel free to reuse an existing folder.",
            ],
            commands: ["mkdir -p {images_dir_unix}", "cd {images_dir_unix}"],
          },
          {
            title: "Download release artifacts",
            body: [
              "Fetch the {artifact_name} bundle from the workflow run. The helper also works for private repositories once gh is authenticated.",
            ],
            commands: [
              "gh run download {run_id} --repo {repository} --name {artifact_name} --dir .",
              "ls -l",
            ],
          },
          {
            title: "Verify checksum before flashing",
            body: [
              "Always confirm the checksum matches to avoid flashing a corrupted image.",
            ],
            commands: ["sha256sum -c {image_name}.sha256"],
          },
          {
            title: "Expand the compressed image",
            body: [
              "Keep the original .xz file for future flashes. The command below expands it to {expanded_image_path_unix}.",
            ],
            commands: ["xz -dk {image_name}"],
          },
          {
            title: "Flash removable media",
            body: [
              "Clone the repository if you have not already, then run the flashing helper with sudo. Replace /dev/sdX with your target device.",
            ],
            commands: [
              "git clone https://github.com/futuroptimist/sugarkube.git  # Skip if cloned",
              "cd sugarkube",
              "sudo ./scripts/flash_pi_media.sh --image {expanded_image_path_unix} --device /dev/sdX --assume-yes",
            ],
          },
        ],
        mac: [
          {
            title: "Install GitHub CLI and dependencies",
            body: [
              "Use Homebrew to install the tooling required to download, verify, and expand the image.",
            ],
            commands: ["brew update", "brew install gh xz coreutils"],
          },
          {
            title: "Authenticate GitHub CLI",
            body: ["Log in once via the browser to access private workflow artifacts."],
            commands: ["gh auth login --web"],
          },
          {
            title: "Prepare the images directory",
            body: [
              "All artifacts are saved to {images_dir_unix}. Adjust the path if you prefer a different location.",
            ],
            commands: ["mkdir -p {images_dir_unix}", "cd {images_dir_unix}"],
          },
          {
            title: "Download workflow artifacts",
            body: [
              "Download the {artifact_name} archive that contains the image, checksums, and provenance metadata.",
            ],
            commands: [
              "gh run download {run_id} --repo {repository} --name {artifact_name} --dir .",
              "ls -lh",
            ],
          },
          {
            title: "Verify checksum before flashing",
            body: [
              "Confirm the SHA-256 hash matches the published value to guard against corruption.",
            ],
            commands: ["shasum -a 256 -c {image_name}.sha256"],
          },
          {
            title: "Expand the compressed image",
            body: [
              "Retain {image_name} for reuse. The following command expands it into {expanded_image_path_unix}.",
            ],
            commands: ["xz -dk {image_name}"],
          },
          {
            title: "Flash the target disk",
            body: [
              "Clone the helpers if needed, unmount the removable disk (diskutil list → diskutil unmountDisk), then flash it with sudo.",
            ],
            commands: [
              "git clone https://github.com/futuroptimist/sugarkube.git  # Skip if cloned",
              "cd sugarkube",
              "sudo ./scripts/flash_pi_media.sh --image {expanded_image_path_unix} --device /dev/diskX --assume-yes",
            ],
          },
        ],
        windows: [
          {
            title: "Install GitHub CLI and Python",
            body: [
              "Use winget to install the GitHub CLI plus Python for checksum verification and decompression.",
            ],
            commands: [
              "winget install --id GitHub.cli -e",
              "winget install --id Python.Python.3.11 -e",
            ],
          },
          {
            title: "Authenticate GitHub CLI",
            body: [
              "The browser-based login allows gh to download artifacts from private runs.",
            ],
            commands: ["gh auth login --web"],
          },
          {
            title: "Create an images directory",
            body: [
              "Store downloads in {images_dir_windows}. Adjust the path if necessary.",
            ],
            commands: [
              "New-Item -ItemType Directory -Path {images_dir_windows} -Force | Out-Null",
            ],
          },
          {
            title: "Download workflow artifacts",
            body: [
              "Download {artifact_name} from the workflow run into the staging directory.",
            ],
            commands: [
              "gh run download {run_id} --repo {repository} --name {artifact_name} --dir {images_dir_windows}",
              "Get-ChildItem {images_dir_windows}",
            ],
          },
          {
            title: "Verify checksum before flashing",
            body: [
              "Compare the published hash with a freshly computed value before writing media.",
            ],
            commands: [
              "$expected = (Get-Content {checksum_path_windows}).Split()[0]",
              "$actual = (Get-FileHash {image_path_windows} -Algorithm SHA256).Hash.ToLower()",
              "if ($actual -ne $expected) {{ throw 'Checksum mismatch' }}",
              "else {{ 'Checksum OK' }}",
            ],
          },
          {
            title: "Expand the compressed image",
            body: [
              "Use Python's built-in lzma module to expand {image_name} into {expanded_image_path_windows}.",
            ],
            commands: [
              "python -c \"import lzma, pathlib, shutil; src = pathlib.Path(r'{image_path_windows_raw}'); dst = src.with_suffix(''); print(f'Expanding {{src.name}} -> {{dst.name}}'); with lzma.open(src, 'rb') as src_f, open(dst, 'wb') as dst_f: shutil.copyfileobj(src_f, dst_f)\"",
            ],
          },
          {
            title: "Flash removable media",
            body: [
              "Clone helpers if needed, then flash with the PowerShell wrapper. Replace X with the correct disk number from Get-Disk.",
            ],
            commands: [
              "git clone https://github.com/futuroptimist/sugarkube.git  # Skip if cloned",
              "Set-Location sugarkube",
              "pwsh -File scripts/flash_pi_media.ps1 --image {expanded_image_path_windows} --device \\\\.\\\\PhysicalDriveX --assume-yes",
            ],
          },
        ],
      };

      function parseWorkflowUrl(url) {
        if (!url) {
          throw new Error("Provide a GitHub Actions run URL.");
        }
        const trimmed = url.trim();
        const patterns = [
          /^https?:\/\/github.com\/(?<owner>[^/]+)\/(?<repo>[^/]+)\/actions\/runs\/(?<run_id>\d+)(?:\/attempts\/\d+)?(?:[/?#].*)?$/i,
          /^https?:\/\/github.com\/(?<owner>[^/]+)\/(?<repo>[^/]+)\/actions\/workflows\/[^/]+\/runs\/(?<run_id>\d+)(?:\/attempts\/\d+)?(?:[/?#].*)?$/i,
        ];
        for (const pattern of patterns) {
          const match = trimmed.match(pattern);
          if (match && match.groups) {
            return {
              owner: match.groups.owner,
              repo: match.groups.repo,
              run_id: match.groups.run_id,
              repository: `${match.groups.owner}/${match.groups.repo}`,
              run_url: `https://github.com/${match.groups.owner}/${match.groups.repo}/actions/runs/${match.groups.run_id}`,
            };
          }
        }
        throw new Error(`Unrecognised workflow run URL: ${trimmed}`);
      }

      function contextFor(info) {
        const imagesDirUnix = "~/sugarkube/images";
        const imagesDirWindows = "$env:USERPROFILE\\sugarkube\\images";
        return {
          repository: info.repository,
          run_id: info.run_id,
          artifact_name: "sugarkube-pi-image",
          image_name: "sugarkube.img.xz",
          images_dir_unix: imagesDirUnix,
          expanded_image_path_unix: `${imagesDirUnix}/sugarkube.img`,
          images_dir_windows: imagesDirWindows,
          image_path_windows: `${imagesDirWindows}\\sugarkube.img.xz`,
          image_path_windows_raw: `${imagesDirWindows}\\sugarkube.img.xz`,
          expanded_image_path_windows: `${imagesDirWindows}\\sugarkube.img`,
          checksum_path_windows: `${imagesDirWindows}\\sugarkube.img.xz.sha256`,
        };
      }

      const TOKEN_PATTERN = /\{([a-z0-9_]+)\}/gi;

      function replaceTokens(value, context) {
        return value.replace(TOKEN_PATTERN, (_, key) => context[key] ?? `{${key}}`);
      }

      function renderSteps(osKey, info) {
        const templates = STEP_TEMPLATES[osKey];
        if (!templates) {
          throw new Error(`Unsupported OS: ${osKey}`);
        }
        const context = contextFor(info);
        return templates.map((template) => ({
          title: replaceTokens(template.title, context),
          body: template.body.map((segment) => replaceTokens(segment, context)),
          commands: template.commands.map((command) => replaceTokens(command, context)),
        }));
      }

      function onSubmit(event) {
        event.preventDefault();
        const error = document.getElementById("error");
        error.hidden = true;
        try {
          const url = document.getElementById("workflow-url").value;
          const osKey = document.getElementById("os").value;
          const info = parseWorkflowUrl(url);
          const steps = renderSteps(osKey, info);
          document.getElementById("results").hidden = false;
          document.getElementById("meta-repo").textContent = `Repo: ${info.repository}`;
          document.getElementById("meta-run").textContent = `Run: ${info.run_url}`;
          document.getElementById("meta-platform").textContent = `Platform: ${OS_LABELS[osKey]}`;
          const stepsContainer = document.getElementById("steps");
          stepsContainer.replaceChildren();
          steps.forEach((step, index) => {
            const article = document.createElement("article");
            article.className = "step";
            const title = document.createElement("h3");
            title.textContent = `${index + 1}. ${step.title}`;
            article.appendChild(title);
            step.body.forEach((paragraph) => {
              const p = document.createElement("p");
              p.textContent = paragraph;
              article.appendChild(p);
            });
            if (step.commands.length) {
              const pre = document.createElement("pre");
              const code = document.createElement("code");
              code.textContent = step.commands.join("\n");
              pre.appendChild(code);
              article.appendChild(pre);
            }
            stepsContainer.appendChild(article);
          });
        } catch (err) {
          error.hidden = false;
          error.textContent = err instanceof Error ? err.message : String(err);
          document.getElementById("results").hidden = true;
        }
      }

      document.getElementById("flash-form").addEventListener("submit", onSubmit);
    </script>
  </body>
</html>
